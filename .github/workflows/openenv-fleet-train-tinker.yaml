name: "Fleet Task Training (Tinker)"

on:
  workflow_dispatch:
    inputs:
      modality:
        description: "Task modality"
        type: choice
        options:
          - tool_use
          - computer_use
        default: tool_use
      env_key:
        description: "Fleet environment filter (empty=all)"
        type: string
        default: ""
      max_tasks:
        description: "Max tasks (empty=all, or number for testing)"
        type: string
        default: ""
      model_name:
        description: "Model to train"
        type: choice
        options:
          - Qwen/Qwen3-8B
          - Qwen/Qwen3-VL-30B-A3B-Instruct
        default: Qwen/Qwen3-8B
      max_steps:
        description: "Maximum training steps"
        type: string
        default: "50"
      batch_size:
        description: "Batch size"
        type: string
        default: "8"
      n_samples_per_prompt:
        description: "Samples per prompt (for GRPO)"
        type: string
        default: "4"
      data_version:
        description: "Dataset version in S3 (e.g., v0.1, v0.2, v0.3)"
        type: string
        default: "v0.3"

permissions:
  contents: read

# One training run at a time on the self-hosted runner
concurrency:
  group: fleet-tinker-training
  cancel-in-progress: false

env:
  TASKS_BUCKET: "fleet-internal-datasets"
  TASKS_PREFIX: "${{ inputs.data_version }}/openenv"

jobs:
  train:
    name: "Train ${{ inputs.model_name }} (by ${{ github.actor }})"
    runs-on: [self-hosted, fleet-runner]
    timeout-minutes: 4320  # 72 hours max

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh || true
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        working-directory: skyrl-train
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e .
          uv pip install "tinker>=0.8.0"
          uv pip install --no-cache-dir "openenv[fleet] @ git+https://github.com/fleet-ai/OpenEnv.git@deniz/fleet_client"

      - name: Configure AWS credentials
        run: |
          mkdir -p ~/.aws
          cat > ~/.aws/credentials << EOF
          [default]
          aws_access_key_id = ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key = ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          EOF
          cat > ~/.aws/config << EOF
          [default]
          region = us-east-1
          EOF

      - name: Generate run name
        id: run
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M")
          RUN_ID=$(head -c 4 /dev/urandom | xxd -p)
          MODALITY="${{ inputs.modality }}"
          MODALITY_DASH=$(echo "$MODALITY" | tr '_' '-')
          RUN_NAME="fleet-${MODALITY_DASH}-${RUN_ID}-${TIMESTAMP}"
          echo "name=$RUN_NAME" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Validate data version
        run: |
          DATA_VERSION="${{ inputs.data_version }}"
          if ! aws s3 ls "s3://${{ env.TASKS_BUCKET }}/${DATA_VERSION}/openenv/" > /dev/null 2>&1; then
            echo "ERROR: Data version '$DATA_VERSION' not found"; exit 1
          fi

      - name: Download tasks from S3
        run: |
          MODALITY="${{ inputs.modality }}"
          TASKS_FILE="all_${MODALITY}.json"
          mkdir -p ./data
          aws s3 cp "s3://${{ env.TASKS_BUCKET }}/${{ env.TASKS_PREFIX }}/${TASKS_FILE}" ./data/tasks.json

      - name: Prepare dataset
        working-directory: skyrl-train
        run: |
          source .venv/bin/activate
          PREPARE_CMD="python -m integrations.fleet.prepare_dataset --tasks-json ../data/tasks.json --output-dir ../data/fleet --modality ${{ inputs.modality }}"
          [ -n "${{ inputs.env_key }}" ] && PREPARE_CMD="$PREPARE_CMD --env-key ${{ inputs.env_key }}"
          [ -n "${{ inputs.max_tasks }}" ] && PREPARE_CMD="$PREPARE_CMD --max-tasks ${{ inputs.max_tasks }}"
          eval "$PREPARE_CMD"

      - name: Notify Slack - Started
        id: slack_start
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "text": "üöÄ Tinker Training Started",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "üöÄ Tinker Training Started" } },
                { "type": "section", "fields": [
                  { "type": "mrkdwn", "text": "*Run:*\n`${{ steps.run.outputs.name }}`" },
                  { "type": "mrkdwn", "text": "*Model:*\n`${{ inputs.model_name }}`" },
                  { "type": "mrkdwn", "text": "*Modality:*\n`${{ inputs.modality }}`" },
                  { "type": "mrkdwn", "text": "*Max Steps:*\n`${{ inputs.max_steps }}`" }
                ]},
                { "type": "context", "elements": [
                  { "type": "mrkdwn", "text": "Triggered by: ${{ github.actor }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow> | <https://wandb.ai/thefleet/fleet-tinker-grpo|WandB>" }
                ]}
              ]
            }

      - name: Run training
        id: training
        working-directory: skyrl-train
        env:
          TINKER_API_URL: ${{ secrets.TINKER_API_URL }}
          TINKER_API_KEY: ${{ secrets.TINKER_API_KEY }}
          FLEET_API_KEY: ${{ secrets.FLEET_API_KEY }}
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY_TOOL_USE }}
        run: |
          source .venv/bin/activate

          python -m integrations.fleet.entrypoints.main_fleet_tinker \
            --model-name "${{ inputs.model_name }}" \
            --tasks-file ../data/tasks.json \
            --dataset-file ../data/fleet/train.parquet \
            --eval-dataset-file ../data/fleet/validation.parquet \
            --batch-size ${{ inputs.batch_size }} \
            --max-steps ${{ inputs.max_steps }} \
            --n-samples-per-prompt ${{ inputs.n_samples_per_prompt }} \
            --max-turns 50 \
            --eval-every 20 \
            --wandb-project fleet-tinker-grpo \
            --wandb-name "${{ steps.run.outputs.name }}"

          echo "status=COMPLETED" >> $GITHUB_OUTPUT

      - name: Notify Slack - Completed
        if: steps.training.outputs.status == 'COMPLETED'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "thread_ts": "${{ steps.slack_start.outputs.ts }}",
              "text": "‚úÖ Training Completed",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "‚úÖ Tinker Training Completed" } },
                { "type": "section", "fields": [
                  { "type": "mrkdwn", "text": "*Run:*\n`${{ steps.run.outputs.name }}`" },
                  { "type": "mrkdwn", "text": "*Status:*\n`COMPLETED`" }
                ]},
                { "type": "section", "text": { "type": "mrkdwn", "text": "<https://wandb.ai/thefleet/fleet-tinker-grpo|View Results on WandB>" } }
              ]
            }

      - name: Notify Slack - Failed
        if: failure()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "thread_ts": "${{ steps.slack_start.outputs.ts }}",
              "text": "‚ùå Training Failed",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "‚ùå Tinker Training Failed" } },
                { "type": "section", "fields": [
                  { "type": "mrkdwn", "text": "*Run:*\n`${{ steps.run.outputs.name }}`" },
                  { "type": "mrkdwn", "text": "*Status:*\n`FAILED`" }
                ]},
                { "type": "section", "text": { "type": "mrkdwn", "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>" } }
              ]
            }

      - name: Summary
        if: always()
        run: |
          echo "## Tinker Training Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run | \`${{ steps.run.outputs.name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Model | \`${{ inputs.model_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | \`${{ steps.training.outputs.status || 'FAILED' }}\` |" >> $GITHUB_STEP_SUMMARY
