name: "Fleet Task Training (Tinker)"

on:
  workflow_dispatch:
    inputs:
      modality:
        description: "Task modality"
        type: choice
        options:
          - tool_use
          - computer_use
        default: tool_use
      env_key:
        description: "Fleet environment filter (empty=all)"
        type: string
        default: ""
      max_tasks:
        description: "Max tasks (empty=all, or number for testing)"
        type: string
        default: ""
      model_name:
        description: "Model to train"
        type: choice
        options:
          - Qwen/Qwen3-8B
          - Qwen/Qwen3-VL-30B-A3B-Instruct
        default: Qwen/Qwen3-8B
      max_steps:
        description: "Maximum training steps"
        type: string
        default: "50"
      batch_size:
        description: "Batch size"
        type: string
        default: "8"
      n_samples_per_prompt:
        description: "Samples per prompt (for GRPO)"
        type: string
        default: "4"
      data_version:
        description: "Dataset version in S3 (e.g., v0.1, v0.2, v0.3)"
        type: string
        default: "v0.3"

permissions:
  contents: read
  actions: write  # Required to trigger monitor workflow

env:
  TASKS_BUCKET: "fleet-internal-datasets"
  TASKS_PREFIX: "${{ inputs.data_version }}/openenv"

jobs:
  launch:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        working-directory: skyrl-train
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e .
          uv pip install "tinker>=0.8.0"
          uv pip install --no-cache-dir "openenv[fleet] @ git+https://github.com/fleet-ai/OpenEnv.git@deniz/fleet_client"

      - name: Configure AWS credentials
        run: |
          mkdir -p ~/.aws
          cat > ~/.aws/credentials << EOF
          [default]
          aws_access_key_id = ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key = ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          EOF
          cat > ~/.aws/config << EOF
          [default]
          region = us-east-1
          EOF

      - name: Generate run name
        id: run
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M")
          RUN_ID=$(head -c 4 /dev/urandom | xxd -p)
          MODALITY="${{ inputs.modality }}"
          MODALITY_DASH=$(echo "$MODALITY" | tr '_' '-')
          RUN_NAME="fleet-${MODALITY_DASH}-${RUN_ID}-${TIMESTAMP}"
          echo "name=$RUN_NAME" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Validate data version
        run: |
          DATA_VERSION="${{ inputs.data_version }}"
          if ! aws s3 ls "s3://${{ env.TASKS_BUCKET }}/${DATA_VERSION}/openenv/" > /dev/null 2>&1; then
            echo "ERROR: Data version '$DATA_VERSION' not found"; exit 1
          fi

      - name: Download tasks from S3
        run: |
          MODALITY="${{ inputs.modality }}"
          TASKS_FILE="all_${MODALITY}.json"
          mkdir -p ./data
          aws s3 cp "s3://${{ env.TASKS_BUCKET }}/${{ env.TASKS_PREFIX }}/${TASKS_FILE}" ./data/tasks.json

      - name: Prepare dataset
        working-directory: skyrl-train
        run: |
          source .venv/bin/activate
          PREPARE_CMD="python -m integrations.fleet.prepare_dataset --tasks-json ../data/tasks.json --output-dir ../data/fleet --modality ${{ inputs.modality }}"
          [ -n "${{ inputs.env_key }}" ] && PREPARE_CMD="$PREPARE_CMD --env-key ${{ inputs.env_key }}"
          [ -n "${{ inputs.max_tasks }}" ] && PREPARE_CMD="$PREPARE_CMD --max-tasks ${{ inputs.max_tasks }}"
          eval "$PREPARE_CMD"

      - name: Upload prepared data as artifact
        uses: actions/upload-artifact@v4
        with:
          name: training-data-${{ steps.run.outputs.run_id }}
          path: data/
          retention-days: 1

      - name: Notify Slack - Started
        id: slack_start
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "text": "ðŸš€ Training Run Started",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "ðŸš€ Training Run Started" } },
                { "type": "section", "fields": [
                  { "type": "mrkdwn", "text": "*Run:*\n`${{ steps.run.outputs.name }}`" },
                  { "type": "mrkdwn", "text": "*Backend:*\n`Tinker`" },
                  { "type": "mrkdwn", "text": "*Model:*\n`${{ inputs.model_name }}`" },
                  { "type": "mrkdwn", "text": "*Modality:*\n`${{ inputs.modality }}`" }
                ]},
                { "type": "context", "elements": [
                  { "type": "mrkdwn", "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow> | <https://wandb.ai/thefleet/fleet-tinker-grpo|WandB>" }
                ]}
              ]
            }

      - name: Trigger Training Workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run openenv-fleet-tinker-train.yaml \
            --field run_name="${{ steps.run.outputs.name }}" \
            --field run_id="${{ steps.run.outputs.run_id }}" \
            --field model_name="${{ inputs.model_name }}" \
            --field modality="${{ inputs.modality }}" \
            --field max_steps="${{ inputs.max_steps }}" \
            --field batch_size="${{ inputs.batch_size }}" \
            --field n_samples_per_prompt="${{ inputs.n_samples_per_prompt }}" \
            --field slack_thread_ts="${{ steps.slack_start.outputs.ts }}" \
            --field iteration=1

      - name: Summary
        run: |
          echo "## Tinker Training Launch" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run | \`${{ steps.run.outputs.name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Model | \`${{ inputs.model_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Training workflow triggered |" >> $GITHUB_STEP_SUMMARY
