name: "Fleet Task Training (Tinker)"

on:
  workflow_dispatch:
    inputs:
      modality:
        description: "Task modality"
        type: choice
        options:
          - tool_use
          - computer_use
        default: tool_use
      env_key:
        description: "Fleet environment filter (empty=all)"
        type: string
        default: ""
      max_tasks:
        description: "Max tasks (empty=all, or number for testing)"
        type: string
        default: ""
      model_name:
        description: "Model to train"
        type: choice
        options:
          - Qwen/Qwen3-8B
          - Qwen/Qwen3-VL-30B-A3B-Instruct
        default: Qwen/Qwen3-8B
      max_steps:
        description: "Maximum training steps"
        type: string
        default: "50"
      batch_size:
        description: "Batch size"
        type: string
        default: "8"
      n_samples_per_prompt:
        description: "Samples per prompt (for GRPO)"
        type: string
        default: "4"

permissions:
  contents: read

env:
  TASKS_BUCKET: "fleet-internal-datasets"
  TASKS_PREFIX: "v0.2/openenv"

jobs:
  train:
    runs-on: ubuntu-latest
    timeout-minutes: 720  # 12 hours max

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        working-directory: skyrl-train
        run: |
          uv venv
          source .venv/bin/activate
          # Install base skyrl-train (no vLLM needed - Tinker handles inference)
          uv pip install -e .
          # Install tinker SDK
          uv pip install "tinker>=0.8.0"
          # Install OpenEnv with [fleet] extra for MCP support (includes mcp and fleet-python)
          uv pip install "openenv[fleet] @ git+https://github.com/fleet-ai/OpenEnv.git@deniz/fleet_client"

      - name: Configure AWS credentials
        run: |
          mkdir -p ~/.aws
          cat > ~/.aws/credentials << EOF
          [default]
          aws_access_key_id = ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key = ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          EOF
          cat > ~/.aws/config << EOF
          [default]
          region = us-east-1
          EOF

      - name: Generate run name
        id: run
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M")
          RUN_ID=$(head -c 4 /dev/urandom | xxd -p)
          MODALITY="${{ inputs.modality }}"
          RUN_NAME="tinker_${MODALITY}_${RUN_ID}_${TIMESTAMP}"
          echo "name=$RUN_NAME" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Generated run name: $RUN_NAME"

      - name: Download tasks from S3
        run: |
          MODALITY="${{ inputs.modality }}"
          TASKS_FILE="all_${MODALITY}.json"
          mkdir -p ./data
          aws s3 cp "s3://${{ env.TASKS_BUCKET }}/${{ env.TASKS_PREFIX }}/${TASKS_FILE}" ./data/tasks.json
          echo "Downloaded tasks to ./data/tasks.json"
          TASK_COUNT=$(python -c "import json; d=json.load(open('./data/tasks.json')); print(len(d) if isinstance(d,list) else len(d.get('tasks',[])))")
          echo "Task count: $TASK_COUNT"

      - name: Prepare dataset
        working-directory: skyrl-train
        run: |
          source .venv/bin/activate

          MODALITY="${{ inputs.modality }}"
          ENV_KEY="${{ inputs.env_key }}"
          MAX_TASKS="${{ inputs.max_tasks }}"

          PREPARE_CMD="python -m integrations.fleet.prepare_dataset"
          PREPARE_CMD="$PREPARE_CMD --tasks-json ../data/tasks.json"
          PREPARE_CMD="$PREPARE_CMD --output-dir ../data/fleet"
          PREPARE_CMD="$PREPARE_CMD --modality $MODALITY"

          if [ -n "$ENV_KEY" ]; then
            PREPARE_CMD="$PREPARE_CMD --env-key $ENV_KEY"
          fi

          if [ -n "$MAX_TASKS" ]; then
            PREPARE_CMD="$PREPARE_CMD --max-tasks $MAX_TASKS"
          fi

          echo "Running: $PREPARE_CMD"
          eval "$PREPARE_CMD"

          echo "Dataset prepared:"
          ls -la ../data/fleet/

      - name: Notify Slack - Training Started
        id: slack_start
        if: success()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "text": "üöÄ Tinker Training Run Started",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "üöÄ Tinker Training Run Started" }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Run:*\n`${{ steps.run.outputs.name }}`" },
                    { "type": "mrkdwn", "text": "*Model:*\n`${{ inputs.model_name }}`" },
                    { "type": "mrkdwn", "text": "*Modality:*\n`${{ inputs.modality }}`" },
                    { "type": "mrkdwn", "text": "*Env Filter:*\n`${{ inputs.env_key || 'all' }}`" }
                  ]
                },
                {
                  "type": "section",
                  "text": { "type": "mrkdwn", "text": "*Backend:* Tinker (hosted)\n*Max Steps:* ${{ inputs.max_steps }}\n*Batch Size:* ${{ inputs.batch_size }}" }
                },
                {
                  "type": "context",
                  "elements": [
                    { "type": "mrkdwn", "text": "Triggered by: ${{ github.actor }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>" }
                  ]
                }
              ]
            }

      - name: Run training
        working-directory: skyrl-train
        env:
          # TINKER_API_URL is optional - SDK uses default if not set
          TINKER_API_URL: ${{ secrets.TINKER_API_URL }}
          TINKER_API_KEY: ${{ secrets.TINKER_API_KEY }}
          FLEET_API_KEY: ${{ secrets.FLEET_API_KEY }}
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY_TOOL_USE }}
        run: |
          source .venv/bin/activate

          python -m integrations.fleet.entrypoints.main_fleet_tinker \
            --model-name "${{ inputs.model_name }}" \
            --tasks-file ../data/tasks.json \
            --dataset-file ../data/fleet/train.parquet \
            --eval-dataset-file ../data/fleet/validation.parquet \
            --batch-size ${{ inputs.batch_size }} \
            --max-steps ${{ inputs.max_steps }} \
            --n-samples-per-prompt ${{ inputs.n_samples_per_prompt }} \
            --max-turns 50 \
            --save-every 10 \
            --eval-every 20 \
            --wandb-project fleet-tinker-grpo \
            --wandb-name "${{ steps.run.outputs.name }}"

      - name: Notify Slack - Training Completed
        if: success() && steps.slack_start.outputs.ts
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "thread_ts": "${{ steps.slack_start.outputs.ts }}",
              "text": "‚úÖ Tinker Training Completed",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "‚úÖ Tinker Training Completed" }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Run:*\n`${{ steps.run.outputs.name }}`" },
                    { "type": "mrkdwn", "text": "*Model:*\n`${{ inputs.model_name }}`" },
                    { "type": "mrkdwn", "text": "*Modality:*\n`${{ inputs.modality }}`" },
                    { "type": "mrkdwn", "text": "*Status:*\n`COMPLETED`" }
                  ]
                },
                {
                  "type": "section",
                  "text": { "type": "mrkdwn", "text": "*WandB:* <https://wandb.ai/thefleet/fleet-tinker-grpo|View Dashboard>" }
                },
                {
                  "type": "context",
                  "elements": [
                    { "type": "mrkdwn", "text": "Triggered by: ${{ github.actor }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>" }
                  ]
                }
              ]
            }

      - name: Notify Slack - Training Failed
        if: failure() && steps.slack_start.outputs.ts
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "thread_ts": "${{ steps.slack_start.outputs.ts }}",
              "text": "‚ùå Tinker Training Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "‚ùå Tinker Training Failed" }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Run:*\n`${{ steps.run.outputs.name }}`" },
                    { "type": "mrkdwn", "text": "*Model:*\n`${{ inputs.model_name }}`" },
                    { "type": "mrkdwn", "text": "*Modality:*\n`${{ inputs.modality }}`" },
                    { "type": "mrkdwn", "text": "*Status:*\n`FAILED`" }
                  ]
                },
                {
                  "type": "section",
                  "text": { "type": "mrkdwn", "text": "*Check logs:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Logs>" }
                },
                {
                  "type": "context",
                  "elements": [
                    { "type": "mrkdwn", "text": "Triggered by: ${{ github.actor }}" }
                  ]
                }
              ]
            }

      - name: Notify Slack - Training Cancelled
        if: cancelled() && steps.slack_start.outputs.ts
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "thread_ts": "${{ steps.slack_start.outputs.ts }}",
              "text": "‚ö†Ô∏è Tinker Training Cancelled",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "‚ö†Ô∏è Tinker Training Cancelled" }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Run:*\n`${{ steps.run.outputs.name }}`" },
                    { "type": "mrkdwn", "text": "*Model:*\n`${{ inputs.model_name }}`" },
                    { "type": "mrkdwn", "text": "*Modality:*\n`${{ inputs.modality }}`" },
                    { "type": "mrkdwn", "text": "*Status:*\n`CANCELLED`" }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    { "type": "mrkdwn", "text": "Triggered by: ${{ github.actor }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>" }
                  ]
                }
              ]
            }

      - name: Summary
        if: always()
        run: |
          echo "## Tinker Fleet Training - ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run | \`${{ steps.run.outputs.name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Model | \`${{ inputs.model_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | Tinker (hosted) |" >> $GITHUB_STEP_SUMMARY
          echo "| Modality | \`${{ inputs.modality }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Env Filter | \`${{ inputs.env_key || 'all' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Max Tasks | \`${{ inputs.max_tasks || 'all' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Max Steps | \`${{ inputs.max_steps }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Batch Size | \`${{ inputs.batch_size }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [WandB Dashboard](https://wandb.ai/thefleet/fleet-tinker-grpo)" >> $GITHUB_STEP_SUMMARY
