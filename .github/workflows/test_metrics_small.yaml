name: Test Metrics Small Config

on:
  push:
    branches:
      - main
      - rc/**
  pull_request:
  workflow_dispatch:

permissions:
  checks: write
  contents: read

# Cancel runs for previous commits on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check_code_quality:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v6
        with:
          activate-environment: true
      - name: Run pre-commit hooks
        run: uv pip install pre-commit; pre-commit run --all-files --config .pre-commit-config.yaml

  test_metrics_small:
    needs: check_code_quality
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v6

      - name: Install skyrl-train dependencies
        working-directory: ./skyrl-train
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Run tinker with small metrics config
        working-directory: ./skyrl-train
        run: |
          source .venv/bin/activate
          python -m skyrl_train.main \
            --config-name tinker \
            trainer.update_epochs_per_batch=1 \
            trainer.policy.track_extra_gradient_metrics=true \
            generator.n_samples_per_prompt=4 \
            generator.max_steps=10 \
            model.model_name_or_path=Qwen/Qwen3-8B \
            --experiment-name "metrics_small_$(date +%s)"
        env:
          # Small config settings for faster iteration
          MODALITY: tool_use
          ENV_KEY: github
          MAX_TASKS: 4
          MAX_STEPS: 10