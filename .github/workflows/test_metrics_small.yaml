name: Test Metrics Small Config

on:
  push:
    branches:
      - main
      - rc/**
  pull_request:
  workflow_dispatch:

permissions:
  checks: write
  contents: read

# Cancel runs for previous commits on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check_code_quality:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v6
        with:
          activate-environment: true
      - name: Run pre-commit hooks
        run: uv pip install pre-commit; pre-commit run --all-files --config .pre-commit-config.yaml

  test_metrics_small:
    needs: check_code_quality
    runs-on: ubuntu-latest
    timeout-minutes: 60  # 1 hour for small test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        working-directory: skyrl-train
        run: |
          uv venv
          source .venv/bin/activate
          # Install base skyrl-train with dev extras (includes tinker)
          uv pip install -e ".[dev]"

      - name: Generate run name
        id: run
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M")
          RUN_ID=$(head -c 4 /dev/urandom | xxd -p)
          RUN_NAME="metrics-test-${RUN_ID}-${TIMESTAMP}"
          echo "name=$RUN_NAME" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Generated run name: $RUN_NAME"

      - name: Set test variables
        id: vars
        run: |
          MODEL_NAME="Qwen/Qwen3-8B"
          echo "model_name=$MODEL_NAME" >> $GITHUB_OUTPUT
          echo "Model: $MODEL_NAME"

      - name: Run tinker with small metrics config
        working-directory: skyrl-train
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY_TOOL_USE }}
        run: |
          source .venv/bin/activate

          python -m skyrl_train.main \
            --config-name tinker \
            trainer.update_epochs_per_batch=1 \
            trainer.policy.track_extra_gradient_metrics=true \
            generator.n_samples_per_prompt=4 \
            generator.max_steps=10 \
            model.model_name_or_path=${{ steps.vars.outputs.model_name }} \
            --experiment-name "${{ steps.run.outputs.name }}"

      - name: Summary
        if: always()
        run: |
          echo "## Gradient Metrics Test - ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run | \`${{ steps.run.outputs.name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Model | \`${{ steps.vars.outputs.model_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Max Steps | 10 |" >> $GITHUB_STEP_SUMMARY
          echo "| Samples per Prompt | 4 |" >> $GITHUB_STEP_SUMMARY
          echo "| Track Gradient Metrics | true |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Metrics Tracked" >> $GITHUB_STEP_SUMMARY
          echo "- Signal-to-Noise Ratio (SNR)" >> $GITHUB_STEP_SUMMARY
          echo "- Bits Edited" >> $GITHUB_STEP_SUMMARY
          echo "- Update Diversity" >> $GITHUB_STEP_SUMMARY