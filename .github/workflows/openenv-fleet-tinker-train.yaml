name: "Fleet Tinker Training (Runner)"

on:
  workflow_dispatch:
    inputs:
      run_name:
        description: "Run name"
        type: string
        required: true
      run_id:
        description: "Run ID (for artifact lookup)"
        type: string
        required: true
      model_name:
        description: "Model to train"
        type: string
        required: true
      modality:
        description: "Task modality"
        type: string
        required: true
      max_steps:
        description: "Maximum training steps"
        type: string
        required: true
      batch_size:
        description: "Batch size"
        type: string
        required: true
      n_samples_per_prompt:
        description: "Samples per prompt"
        type: string
        required: true
      slack_thread_ts:
        description: "Slack thread timestamp"
        type: string
        required: true
      iteration:
        description: "Training iteration (1-12)"
        type: string
        required: true
        default: "1"
      triggered_by:
        description: "Original user who triggered the training"
        type: string
        required: false
        default: "unknown"

permissions:
  contents: read
  actions: write

# Concurrency for the same run
concurrency:
  group: tinker-runner-${{ inputs.run_name }}
  cancel-in-progress: false

jobs:
  train:
    name: "Train ${{ inputs.run_name }} (iter ${{ inputs.iteration }}) by ${{ inputs.triggered_by }}"
    runs-on: ubuntu-latest
    timeout-minutes: 350  # ~5.8 hours

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        working-directory: skyrl-train
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e .
          uv pip install "tinker>=0.8.0"
          uv pip install --no-cache-dir "openenv[fleet] @ git+https://github.com/fleet-ai/OpenEnv.git@deniz/fleet_client"

      - name: Configure AWS credentials
        run: |
          mkdir -p ~/.aws
          cat > ~/.aws/credentials << EOF
          [default]
          aws_access_key_id = ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key = ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          EOF
          cat > ~/.aws/config << EOF
          [default]
          region = us-east-1
          EOF

      - name: Download training data artifact
        uses: actions/download-artifact@v4
        with:
          name: training-data-${{ inputs.run_id }}
          path: data/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: Fallback - Download from S3 if artifact missing
        if: failure() || !hashFiles('data/tasks.json')
        run: |
          echo "Artifact not found, downloading from S3..."
          MODALITY="${{ inputs.modality }}"
          mkdir -p ./data/fleet
          aws s3 cp "s3://fleet-internal-datasets/v0.3/openenv/all_${MODALITY}.json" ./data/tasks.json
          # Re-prepare dataset
          cd skyrl-train
          source .venv/bin/activate
          python -m integrations.fleet.prepare_dataset --tasks-json ../data/tasks.json --output-dir ../data/fleet --modality $MODALITY

      - name: Run training
        id: training
        working-directory: skyrl-train
        env:
          TINKER_API_URL: ${{ secrets.TINKER_API_URL }}
          TINKER_API_KEY: ${{ secrets.TINKER_API_KEY }}
          FLEET_API_KEY: ${{ secrets.FLEET_API_KEY }}
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY_TOOL_USE }}
        run: |
          source .venv/bin/activate

          ITERATION="${{ inputs.iteration }}"
          echo "=== Training iteration $ITERATION/12 ==="

          # Run training
          python -m integrations.fleet.entrypoints.main_fleet_tinker \
            --model-name "${{ inputs.model_name }}" \
            --tasks-file ../data/tasks.json \
            --dataset-file ../data/fleet/train.parquet \
            --eval-dataset-file ../data/fleet/validation.parquet \
            --batch-size ${{ inputs.batch_size }} \
            --max-steps ${{ inputs.max_steps }} \
            --n-samples-per-prompt ${{ inputs.n_samples_per_prompt }} \
            --max-turns 50 \
            --eval-every 20 \
            --wandb-project fleet-tinker-grpo \
            --wandb-name "${{ inputs.run_name }}" \
            && echo "status=COMPLETED" >> $GITHUB_OUTPUT \
            || echo "status=FAILED" >> $GITHUB_OUTPUT

      - name: Notify Slack - Completed
        if: steps.training.outputs.status == 'COMPLETED'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "thread_ts": "${{ inputs.slack_thread_ts }}",
              "text": "✅ Training Completed",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "✅ Training Completed" } },
                { "type": "section", "fields": [
                  { "type": "mrkdwn", "text": "*Run:*\n`${{ inputs.run_name }}`" },
                  { "type": "mrkdwn", "text": "*Status:*\n`COMPLETED`" }
                ]},
                { "type": "section", "text": { "type": "mrkdwn", "text": "<https://wandb.ai/thefleet/fleet-tinker-grpo|View Results on WandB>" } }
              ]
            }

      - name: Notify Slack - Failed
        if: steps.training.outputs.status == 'FAILED'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "thread_ts": "${{ inputs.slack_thread_ts }}",
              "text": "❌ Training Failed",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "❌ Training Failed" } },
                { "type": "section", "fields": [
                  { "type": "mrkdwn", "text": "*Run:*\n`${{ inputs.run_name }}`" },
                  { "type": "mrkdwn", "text": "*Status:*\n`FAILED`" }
                ]},
                { "type": "section", "text": { "type": "mrkdwn", "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>" } }
              ]
            }

      - name: Notify Slack - Cancelled/Timeout
        if: cancelled()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "thread_ts": "${{ inputs.slack_thread_ts }}",
              "text": "⚠️ Training Interrupted",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "⚠️ Training Interrupted" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "*Run:* `${{ inputs.run_name }}`\n*Iteration:* ${{ inputs.iteration }}/12\n\nJob was cancelled or timed out. Check WandB for partial results." } }
              ]
            }

      - name: Summary
        if: always()
        run: |
          echo "## Tinker Training - Iteration ${{ inputs.iteration }}" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run | \`${{ inputs.run_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Model | \`${{ inputs.model_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | \`${{ steps.training.outputs.status || 'UNKNOWN' }}\` |" >> $GITHUB_STEP_SUMMARY
