name: "Fleet Task Training (SkyPilot)"

on:
  workflow_dispatch:
    inputs:
      modality:
        description: "Task modality"
        type: choice
        options:
          - tool_use
          - computer_use
        default: tool_use
      env_keys:
        description: "Fleet environment filter (empty=all, or comma-separated: github,booking,reddit)"
        type: string
        default: ""
      max_tasks:
        description: "Max tasks (empty=all, or number for testing)"
        type: string
        default: ""
      cloud:
        description: "Preferred cloud (any = auto-select cheapest)"
        type: choice
        options:
          - any
          - lambda
          - runpod
          - vast
          - nebius
        default: any
      task_name:
        description: "SkyPilot task name (YAML file in skyrl-train/tasks/)"
        type: choice
        options:
          - openenv-fleet-grpo-qwen3-8b
          - openenv-fleet-grpo-qwen3-32b
          - openenv-fleet-grpo-qwen3-8b-step-wise
          - openenv-fleet-grpo-qwen3-vl-8b
          - openenv-fleet-grpo-xlam-70b
          - openenv-fleet-grpo-glm-4.7-flash
        default: "openenv-fleet-grpo-qwen3-8b"
      data_version:
        description: "Dataset version in S3 (e.g., v0.1, v0.2, v0.3)"
        type: string
        default: "v0.3"
      resume_run_name:
        description: "Resume from S3 checkpoint (W&B run name, e.g., fleet_tool_use_32b_d7167c1c)"
        type: string
        default: ""
      disable_slack:
        description: "Disable Slack notifications (for debugging)"
        type: boolean
        default: false

permissions:
  contents: read

# Allow multiple concurrent training runs for experimentation
concurrency:
  group: fleet-training-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  train:
    name: "Train ${{ inputs.modality }} (by ${{ github.actor }})"
    runs-on: [self-hosted, fleet-runner]
    timeout-minutes: 4320  # 72 hours max

    env:
      WANDB_KEY_TOOL_USE: ${{ secrets.WANDB_API_KEY_TOOL_USE }}
      WANDB_KEY_COMPUTER_USE: ${{ secrets.WANDB_API_KEY_COMPUTER_USE }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Cloud Credentials
        run: |
          mkdir -p ~/.lambda_cloud && echo "api_key = ${{ secrets.LAMBDA_API_KEY }}" > ~/.lambda_cloud/lambda_keys
          pip3 install runpod 2>/dev/null || true && runpod config "${{ secrets.RUNPOD_API_KEY }}" || true
          mkdir -p ~/.config/vastai && echo "${{ secrets.VAST_API_KEY }}" > ~/.config/vastai/vast_api_key
          pip3 install prime 2>/dev/null || true && prime config set-api-key "${{ secrets.PRIME_INTELLECT_API_KEY }}" || true
          mkdir -p ~/.nebius && echo '${{ secrets.NEBIUS_CREDENTIALS_JSON }}' > ~/.nebius/credentials.json
          echo "${{ secrets.NEBIUS_TENANT_ID }}" > ~/.nebius/NEBIUS_TENANT_ID.txt

      - name: Verify Cloud Credentials
        run: sky check lambda runpod vast primeintellect nebius || true

      - name: Validate data version
        run: |
          DATA_VERSION="${{ inputs.data_version }}"
          if ! aws s3 ls "s3://fleet-internal-datasets/${DATA_VERSION}/openenv/" > /dev/null 2>&1; then
            echo "ERROR: Data version '$DATA_VERSION' not found"; exit 1
          fi

      - name: Generate Cluster Name
        id: cluster
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M")
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          CLUSTER_NAME="fleet-${{ inputs.modality }}-${SHORT_SHA}-${TIMESTAMP}"
          CLUSTER_NAME=$(echo "$CLUSTER_NAME" | tr '_' '-' | tr '[:upper:]' '[:lower:]')
          echo "name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          RUN_ID=$(head -c 4 /dev/urandom | xxd -p)
          echo "wandb_run_name=fleet_${{ inputs.modality }}_${RUN_ID}" >> $GITHUB_OUTPUT

      - name: Notify Slack - Starting
        if: ${{ inputs.disable_slack != true }}
        id: slack_start
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "text": "üöÄ Training Run Started",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "üöÄ Training Run Started" } },
                { "type": "section", "fields": [
                  { "type": "mrkdwn", "text": "*Cluster:*\n`${{ steps.cluster.outputs.name }}`" },
                  { "type": "mrkdwn", "text": "*Task:*\n`${{ inputs.task_name }}`" },
                  { "type": "mrkdwn", "text": "*Modality:*\n`${{ inputs.modality }}`" },
                  { "type": "mrkdwn", "text": "*WandB:*\n`${{ steps.cluster.outputs.wandb_run_name }}`" }
                ]},
                { "type": "context", "elements": [
                  { "type": "mrkdwn", "text": "Triggered by: ${{ github.actor }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow> | <https://wandb.ai/thefleet/fleet-task-grpo|WandB>" }
                ]}
              ]
            }

      - name: Launch Training Cluster
        id: launch
        run: |
          MODALITY="${{ inputs.modality }}"
          if [ "$MODALITY" == "tool_use" ]; then WANDB_KEY="$WANDB_KEY_TOOL_USE"; else WANDB_KEY="$WANDB_KEY_COMPUTER_USE"; fi
          [ -z "$WANDB_KEY" ] && echo "ERROR: WANDB key not set" && exit 1

          LAUNCH_CMD="sky launch skyrl-train/tasks/${{ inputs.task_name }}.yaml"
          LAUNCH_CMD="$LAUNCH_CMD --cluster ${{ steps.cluster.outputs.name }}"
          LAUNCH_CMD="$LAUNCH_CMD --env WANDB_API_KEY=$WANDB_KEY"
          LAUNCH_CMD="$LAUNCH_CMD --env FLEET_API_KEY=${{ secrets.FLEET_API_KEY }}"
          LAUNCH_CMD="$LAUNCH_CMD --env MODALITY=$MODALITY"
          LAUNCH_CMD="$LAUNCH_CMD --env DATA_VERSION=${{ inputs.data_version }}"
          LAUNCH_CMD="$LAUNCH_CMD --env AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}"
          LAUNCH_CMD="$LAUNCH_CMD --env AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          [ -n "${{ inputs.env_keys }}" ] && LAUNCH_CMD="$LAUNCH_CMD --env ENV_KEYS=${{ inputs.env_keys }}"
          [ -n "${{ inputs.max_tasks }}" ] && LAUNCH_CMD="$LAUNCH_CMD --env MAX_TASKS=${{ inputs.max_tasks }}"
          [ -n "${{ inputs.resume_run_name }}" ] && LAUNCH_CMD="$LAUNCH_CMD --env RESUME_RUN_NAME=${{ inputs.resume_run_name }}"
          LAUNCH_CMD="$LAUNCH_CMD -y"  # No -d flag, run attached to stream logs

          echo "Command: $LAUNCH_CMD"
          eval "$LAUNCH_CMD"
          echo "status=SUCCEEDED" >> $GITHUB_OUTPUT

      - name: Cleanup Cluster
        if: always()
        run: |
          echo "Cleaning up cluster ${{ steps.cluster.outputs.name }}..."
          sky down "${{ steps.cluster.outputs.name }}" -y || true

      - name: Cleanup Runner Disk
        if: always()
        run: |
          echo "Disk usage before cleanup:"
          df -h . | tail -1
          # Clean old SkyPilot logs (keep last 3 days)
          find ~/.sky/logs -type f -mtime +3 -delete 2>/dev/null || true
          find ~/.sky/logs -type d -empty -delete 2>/dev/null || true
          # Clean old SkyPilot cluster metadata for downed clusters
          sky status --refresh 2>/dev/null || true
          # Clean pip cache
          pip cache purge 2>/dev/null || true
          # Clean apt cache
          sudo apt-get clean 2>/dev/null || true
          # Clean old GHA runner work directories (keep current run)
          WORK_DIR="${GITHUB_WORKSPACE%/*}"
          if [ -d "$WORK_DIR" ]; then
            for dir in "$WORK_DIR"/*/; do
              [ "$dir" = "${GITHUB_WORKSPACE}/" ] && continue
              echo "Removing old work dir: $dir"
              rm -rf "$dir" 2>/dev/null || true
            done
          fi
          echo "Disk usage after cleanup:"
          df -h . | tail -1

      - name: Notify Slack - Completed
        if: steps.launch.outputs.status == 'SUCCEEDED' && inputs.disable_slack != true
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "thread_ts": "${{ steps.slack_start.outputs.ts }}",
              "text": "‚úÖ Training Completed",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "‚úÖ Training Completed" } },
                { "type": "section", "fields": [
                  { "type": "mrkdwn", "text": "*Cluster:*\n`${{ steps.cluster.outputs.name }}`" },
                  { "type": "mrkdwn", "text": "*Status:*\n`SUCCEEDED`" }
                ]},
                { "type": "section", "text": { "type": "mrkdwn", "text": "<https://wandb.ai/thefleet/fleet-task-grpo|View Results on WandB>" } }
              ]
            }

      - name: Notify Slack - Failed
        if: failure() && inputs.disable_slack != true
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "thread_ts": "${{ steps.slack_start.outputs.ts }}",
              "text": "‚ùå Training Failed",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "‚ùå Training Failed" } },
                { "type": "section", "fields": [
                  { "type": "mrkdwn", "text": "*Cluster:*\n`${{ steps.cluster.outputs.name }}`" },
                  { "type": "mrkdwn", "text": "*Status:*\n`FAILED`" }
                ]},
                { "type": "section", "text": { "type": "mrkdwn", "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>" } }
              ]
            }

      - name: Notify Slack - Cancelled
        if: cancelled() && inputs.disable_slack != true
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "thread_ts": "${{ steps.slack_start.outputs.ts }}",
              "text": "‚ö†Ô∏è Training Cancelled",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "‚ö†Ô∏è Training Cancelled" } },
                { "type": "section", "fields": [
                  { "type": "mrkdwn", "text": "*Cluster:*\n`${{ steps.cluster.outputs.name }}`" },
                  { "type": "mrkdwn", "text": "*Status:*\n`CANCELLED`" }
                ]},
                { "type": "context", "elements": [
                  { "type": "mrkdwn", "text": "Cancelled by user or superseded by new run" }
                ]}
              ]
            }

      - name: Summary
        if: always()
        run: |
          echo "## Training Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster | \`${{ steps.cluster.outputs.name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| WandB | \`${{ steps.cluster.outputs.wandb_run_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | \`${{ steps.launch.outputs.status || 'FAILED' }}\` |" >> $GITHUB_STEP_SUMMARY
