name: "Fleet Task Training (SkyPilot)"

on:
  workflow_dispatch:
    inputs:
      modality:
        description: "Task modality"
        type: choice
        options:
          - tool_use
          - computer_use
        default: tool_use
      env_key:
        description: "Fleet environment filter (empty=all, or: github, booking, reddit, etc.)"
        type: string
        default: ""
      max_tasks:
        description: "Max tasks (empty=all, or number for testing)"
        type: string
        default: ""
      cloud:
        description: "Preferred cloud (any = auto-select cheapest)"
        type: choice
        options:
          - any
          - lambda
          - runpod
          - vast
          - nebius
        default: any
      task_name:
        description: "SkyPilot task name (YAML file in skyrl-train/tasks/)"
        type: string
        default: "openenv-fleet-grpo-qwen3-8b"
      data_version:
        description: "Dataset version in S3 (e.g., v0.1, v0.2, v0.3)"
        type: string
        default: "v0.3"

permissions:
  contents: read

env:
  RUN_NAME_PREFIX: "fleet-task"

jobs:
  launch-training:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      cluster_name: ${{ steps.cluster.outputs.name }}
      wandb_run_name: ${{ steps.cluster.outputs.wandb_run_name }}
      slack_ts: ${{ steps.slack_start.outputs.ts }}
    env:
      WANDB_KEY_TOOL_USE: ${{ secrets.WANDB_API_KEY_TOOL_USE }}
      WANDB_KEY_COMPUTER_USE: ${{ secrets.WANDB_API_KEY_COMPUTER_USE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install SkyPilot
        run: pip install "skypilot[lambda,runpod,vast,primeintellect,nebius]"

      - name: Configure Cloud Credentials
        run: |
          mkdir -p ~/.lambda_cloud && echo "api_key = ${{ secrets.LAMBDA_API_KEY }}" > ~/.lambda_cloud/lambda_keys
          pip install runpod && runpod config "${{ secrets.RUNPOD_API_KEY }}"
          mkdir -p ~/.config/vastai && echo "${{ secrets.VAST_API_KEY }}" > ~/.config/vastai/vast_api_key
          pip install prime && prime config set-api-key "${{ secrets.PRIME_INTELLECT_API_KEY }}"
          mkdir -p ~/.nebius && echo '${{ secrets.NEBIUS_CREDENTIALS_JSON }}' > ~/.nebius/credentials.json
          echo "${{ secrets.NEBIUS_TENANT_ID }}" > ~/.nebius/NEBIUS_TENANT_ID.txt

      - name: Verify Cloud Credentials
        run: sky check lambda runpod vast primeintellect nebius

      - name: Validate data version
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          DATA_VERSION="${{ inputs.data_version }}"
          if ! aws s3 ls "s3://fleet-internal-datasets/${DATA_VERSION}/openenv/" > /dev/null 2>&1; then
            echo "ERROR: Data version '$DATA_VERSION' not found"; exit 1
          fi

      - name: Generate Cluster Name
        id: cluster
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M")
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          CLUSTER_NAME="fleet-${{ inputs.modality }}-${SHORT_SHA}-${TIMESTAMP}"
          CLUSTER_NAME=$(echo "$CLUSTER_NAME" | tr '_' '-' | tr '[:upper:]' '[:lower:]')
          echo "name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          RUN_ID=$(head -c 4 /dev/urandom | xxd -p)
          echo "wandb_run_name=fleet_${{ inputs.modality }}_${RUN_ID}" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Launch Training Cluster
        run: |
          MODALITY="${{ inputs.modality }}"
          if [ "$MODALITY" == "tool_use" ]; then WANDB_KEY="$WANDB_KEY_TOOL_USE"; else WANDB_KEY="$WANDB_KEY_COMPUTER_USE"; fi
          [ -z "$WANDB_KEY" ] && echo "ERROR: WANDB key not set" && exit 1

          LAUNCH_CMD="sky launch skyrl-train/tasks/${{ inputs.task_name }}.yaml"
          LAUNCH_CMD="$LAUNCH_CMD --cluster ${{ steps.cluster.outputs.name }}"
          LAUNCH_CMD="$LAUNCH_CMD --env WANDB_API_KEY=$WANDB_KEY"
          LAUNCH_CMD="$LAUNCH_CMD --env FLEET_API_KEY=${{ secrets.FLEET_API_KEY }}"
          LAUNCH_CMD="$LAUNCH_CMD --env MODALITY=$MODALITY"
          LAUNCH_CMD="$LAUNCH_CMD --env RUN_ID=${{ steps.cluster.outputs.run_id }}"
          LAUNCH_CMD="$LAUNCH_CMD --env DATA_VERSION=${{ inputs.data_version }}"
          LAUNCH_CMD="$LAUNCH_CMD --env AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}"
          LAUNCH_CMD="$LAUNCH_CMD --env AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          [ -n "${{ inputs.env_key }}" ] && LAUNCH_CMD="$LAUNCH_CMD --env ENV_KEY=${{ inputs.env_key }}"
          [ -n "${{ inputs.max_tasks }}" ] && LAUNCH_CMD="$LAUNCH_CMD --env MAX_TASKS=${{ inputs.max_tasks }}"
          LAUNCH_CMD="$LAUNCH_CMD -d -y"

          echo "Command: $LAUNCH_CMD"
          eval "$LAUNCH_CMD"

      - name: Notify Slack - Started
        id: slack_start
        if: success()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "text": "üöÄ Training Run Started",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "üöÄ Training Run Started" } },
                { "type": "section", "fields": [
                  { "type": "mrkdwn", "text": "*Cluster:*\n`${{ steps.cluster.outputs.name }}`" },
                  { "type": "mrkdwn", "text": "*Task:*\n`${{ inputs.task_name }}`" },
                  { "type": "mrkdwn", "text": "*Modality:*\n`${{ inputs.modality }}`" },
                  { "type": "mrkdwn", "text": "*WandB:*\n`${{ steps.cluster.outputs.wandb_run_name }}`" }
                ]},
                { "type": "context", "elements": [
                  { "type": "mrkdwn", "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow> | <https://wandb.ai/thefleet/fleet-task-grpo|WandB>" }
                ]}
              ]
            }

      - name: Notify Slack - Launch Failed
        if: failure()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "text": "‚ùå Cluster Launch Failed",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "‚ùå Cluster Launch Failed" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "*Cluster:* `${{ steps.cluster.outputs.name }}`\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>" } }
              ]
            }

  # Monitor jobs chain: each runs for ~5.8h, passes status to next
  # 12 jobs √ó 5.8h = ~70h total coverage (within 72h workflow limit)

  monitor-1:
    needs: launch-training
    runs-on: ubuntu-latest
    timeout-minutes: 350
    outputs:
      status: ${{ steps.monitor.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - name: Setup SkyPilot
        run: |
          pip install "skypilot[lambda,runpod,vast,primeintellect,nebius]" runpod prime
          mkdir -p ~/.lambda_cloud && echo "api_key = ${{ secrets.LAMBDA_API_KEY }}" > ~/.lambda_cloud/lambda_keys
          runpod config "${{ secrets.RUNPOD_API_KEY }}"
          mkdir -p ~/.config/vastai && echo "${{ secrets.VAST_API_KEY }}" > ~/.config/vastai/vast_api_key
          prime config set-api-key "${{ secrets.PRIME_INTELLECT_API_KEY }}"
          mkdir -p ~/.nebius && echo '${{ secrets.NEBIUS_CREDENTIALS_JSON }}' > ~/.nebius/credentials.json
          echo "${{ secrets.NEBIUS_TENANT_ID }}" > ~/.nebius/NEBIUS_TENANT_ID.txt
          sky check lambda runpod vast primeintellect nebius
      - name: Stream Logs (hours 0-6)
        id: monitor
        run: |
          CLUSTER="${{ needs.launch-training.outputs.cluster_name }}"
          echo "=== Monitor job 1/12: Streaming logs for $CLUSTER ==="
          sky logs "$CLUSTER" 2>&1 | tee /tmp/logs.txt || true
          if grep -q "Job finished (status: SUCCEEDED)" /tmp/logs.txt; then
            echo "status=SUCCEEDED" >> $GITHUB_OUTPUT
          elif grep -q "Job finished (status: FAILED)" /tmp/logs.txt; then
            echo "status=FAILED" >> $GITHUB_OUTPUT
          else
            echo "status=RUNNING" >> $GITHUB_OUTPUT
          fi
      - name: Cleanup if done
        if: steps.monitor.outputs.status == 'SUCCEEDED' || steps.monitor.outputs.status == 'FAILED'
        run: sky down "${{ needs.launch-training.outputs.cluster_name }}" -y || true

  monitor-2:
    needs: [launch-training, monitor-1]
    if: needs.monitor-1.outputs.status == 'RUNNING'
    runs-on: ubuntu-latest
    timeout-minutes: 350
    outputs:
      status: ${{ steps.monitor.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - name: Setup SkyPilot
        run: |
          pip install "skypilot[lambda,runpod,vast,primeintellect,nebius]" runpod prime
          mkdir -p ~/.lambda_cloud && echo "api_key = ${{ secrets.LAMBDA_API_KEY }}" > ~/.lambda_cloud/lambda_keys
          runpod config "${{ secrets.RUNPOD_API_KEY }}"
          mkdir -p ~/.config/vastai && echo "${{ secrets.VAST_API_KEY }}" > ~/.config/vastai/vast_api_key
          prime config set-api-key "${{ secrets.PRIME_INTELLECT_API_KEY }}"
          mkdir -p ~/.nebius && echo '${{ secrets.NEBIUS_CREDENTIALS_JSON }}' > ~/.nebius/credentials.json
          echo "${{ secrets.NEBIUS_TENANT_ID }}" > ~/.nebius/NEBIUS_TENANT_ID.txt
          sky check lambda runpod vast primeintellect nebius
      - name: Stream Logs (hours 6-12)
        id: monitor
        run: |
          CLUSTER="${{ needs.launch-training.outputs.cluster_name }}"
          echo "=== Monitor job 2/12: Streaming logs for $CLUSTER ==="
          sky logs "$CLUSTER" 2>&1 | tee /tmp/logs.txt || true
          if grep -q "Job finished (status: SUCCEEDED)" /tmp/logs.txt; then
            echo "status=SUCCEEDED" >> $GITHUB_OUTPUT
          elif grep -q "Job finished (status: FAILED)" /tmp/logs.txt; then
            echo "status=FAILED" >> $GITHUB_OUTPUT
          else
            echo "status=RUNNING" >> $GITHUB_OUTPUT
          fi
      - name: Cleanup if done
        if: steps.monitor.outputs.status == 'SUCCEEDED' || steps.monitor.outputs.status == 'FAILED'
        run: sky down "${{ needs.launch-training.outputs.cluster_name }}" -y || true

  monitor-3:
    needs: [launch-training, monitor-2]
    if: needs.monitor-2.outputs.status == 'RUNNING'
    runs-on: ubuntu-latest
    timeout-minutes: 350
    outputs:
      status: ${{ steps.monitor.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - name: Setup SkyPilot
        run: |
          pip install "skypilot[lambda,runpod,vast,primeintellect,nebius]" runpod prime
          mkdir -p ~/.lambda_cloud && echo "api_key = ${{ secrets.LAMBDA_API_KEY }}" > ~/.lambda_cloud/lambda_keys
          runpod config "${{ secrets.RUNPOD_API_KEY }}"
          mkdir -p ~/.config/vastai && echo "${{ secrets.VAST_API_KEY }}" > ~/.config/vastai/vast_api_key
          prime config set-api-key "${{ secrets.PRIME_INTELLECT_API_KEY }}"
          mkdir -p ~/.nebius && echo '${{ secrets.NEBIUS_CREDENTIALS_JSON }}' > ~/.nebius/credentials.json
          echo "${{ secrets.NEBIUS_TENANT_ID }}" > ~/.nebius/NEBIUS_TENANT_ID.txt
          sky check lambda runpod vast primeintellect nebius
      - name: Stream Logs (hours 12-18)
        id: monitor
        run: |
          CLUSTER="${{ needs.launch-training.outputs.cluster_name }}"
          echo "=== Monitor job 3/12: Streaming logs for $CLUSTER ==="
          sky logs "$CLUSTER" 2>&1 | tee /tmp/logs.txt || true
          if grep -q "Job finished (status: SUCCEEDED)" /tmp/logs.txt; then
            echo "status=SUCCEEDED" >> $GITHUB_OUTPUT
          elif grep -q "Job finished (status: FAILED)" /tmp/logs.txt; then
            echo "status=FAILED" >> $GITHUB_OUTPUT
          else
            echo "status=RUNNING" >> $GITHUB_OUTPUT
          fi
      - name: Cleanup if done
        if: steps.monitor.outputs.status == 'SUCCEEDED' || steps.monitor.outputs.status == 'FAILED'
        run: sky down "${{ needs.launch-training.outputs.cluster_name }}" -y || true

  monitor-4:
    needs: [launch-training, monitor-3]
    if: needs.monitor-3.outputs.status == 'RUNNING'
    runs-on: ubuntu-latest
    timeout-minutes: 350
    outputs:
      status: ${{ steps.monitor.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - name: Setup SkyPilot
        run: |
          pip install "skypilot[lambda,runpod,vast,primeintellect,nebius]" runpod prime
          mkdir -p ~/.lambda_cloud && echo "api_key = ${{ secrets.LAMBDA_API_KEY }}" > ~/.lambda_cloud/lambda_keys
          runpod config "${{ secrets.RUNPOD_API_KEY }}"
          mkdir -p ~/.config/vastai && echo "${{ secrets.VAST_API_KEY }}" > ~/.config/vastai/vast_api_key
          prime config set-api-key "${{ secrets.PRIME_INTELLECT_API_KEY }}"
          mkdir -p ~/.nebius && echo '${{ secrets.NEBIUS_CREDENTIALS_JSON }}' > ~/.nebius/credentials.json
          echo "${{ secrets.NEBIUS_TENANT_ID }}" > ~/.nebius/NEBIUS_TENANT_ID.txt
          sky check lambda runpod vast primeintellect nebius
      - name: Stream Logs (hours 18-24)
        id: monitor
        run: |
          CLUSTER="${{ needs.launch-training.outputs.cluster_name }}"
          echo "=== Monitor job 4/12: Streaming logs for $CLUSTER ==="
          sky logs "$CLUSTER" 2>&1 | tee /tmp/logs.txt || true
          if grep -q "Job finished (status: SUCCEEDED)" /tmp/logs.txt; then
            echo "status=SUCCEEDED" >> $GITHUB_OUTPUT
          elif grep -q "Job finished (status: FAILED)" /tmp/logs.txt; then
            echo "status=FAILED" >> $GITHUB_OUTPUT
          else
            echo "status=RUNNING" >> $GITHUB_OUTPUT
          fi
      - name: Cleanup if done
        if: steps.monitor.outputs.status == 'SUCCEEDED' || steps.monitor.outputs.status == 'FAILED'
        run: sky down "${{ needs.launch-training.outputs.cluster_name }}" -y || true

  monitor-5:
    needs: [launch-training, monitor-4]
    if: needs.monitor-4.outputs.status == 'RUNNING'
    runs-on: ubuntu-latest
    timeout-minutes: 350
    outputs:
      status: ${{ steps.monitor.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - name: Setup SkyPilot
        run: |
          pip install "skypilot[lambda,runpod,vast,primeintellect,nebius]" runpod prime
          mkdir -p ~/.lambda_cloud && echo "api_key = ${{ secrets.LAMBDA_API_KEY }}" > ~/.lambda_cloud/lambda_keys
          runpod config "${{ secrets.RUNPOD_API_KEY }}"
          mkdir -p ~/.config/vastai && echo "${{ secrets.VAST_API_KEY }}" > ~/.config/vastai/vast_api_key
          prime config set-api-key "${{ secrets.PRIME_INTELLECT_API_KEY }}"
          mkdir -p ~/.nebius && echo '${{ secrets.NEBIUS_CREDENTIALS_JSON }}' > ~/.nebius/credentials.json
          echo "${{ secrets.NEBIUS_TENANT_ID }}" > ~/.nebius/NEBIUS_TENANT_ID.txt
          sky check lambda runpod vast primeintellect nebius
      - name: Stream Logs (hours 24-30)
        id: monitor
        run: |
          CLUSTER="${{ needs.launch-training.outputs.cluster_name }}"
          echo "=== Monitor job 5/12: Streaming logs for $CLUSTER ==="
          sky logs "$CLUSTER" 2>&1 | tee /tmp/logs.txt || true
          if grep -q "Job finished (status: SUCCEEDED)" /tmp/logs.txt; then
            echo "status=SUCCEEDED" >> $GITHUB_OUTPUT
          elif grep -q "Job finished (status: FAILED)" /tmp/logs.txt; then
            echo "status=FAILED" >> $GITHUB_OUTPUT
          else
            echo "status=RUNNING" >> $GITHUB_OUTPUT
          fi
      - name: Cleanup if done
        if: steps.monitor.outputs.status == 'SUCCEEDED' || steps.monitor.outputs.status == 'FAILED'
        run: sky down "${{ needs.launch-training.outputs.cluster_name }}" -y || true

  monitor-6:
    needs: [launch-training, monitor-5]
    if: needs.monitor-5.outputs.status == 'RUNNING'
    runs-on: ubuntu-latest
    timeout-minutes: 350
    outputs:
      status: ${{ steps.monitor.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - name: Setup SkyPilot
        run: |
          pip install "skypilot[lambda,runpod,vast,primeintellect,nebius]" runpod prime
          mkdir -p ~/.lambda_cloud && echo "api_key = ${{ secrets.LAMBDA_API_KEY }}" > ~/.lambda_cloud/lambda_keys
          runpod config "${{ secrets.RUNPOD_API_KEY }}"
          mkdir -p ~/.config/vastai && echo "${{ secrets.VAST_API_KEY }}" > ~/.config/vastai/vast_api_key
          prime config set-api-key "${{ secrets.PRIME_INTELLECT_API_KEY }}"
          mkdir -p ~/.nebius && echo '${{ secrets.NEBIUS_CREDENTIALS_JSON }}' > ~/.nebius/credentials.json
          echo "${{ secrets.NEBIUS_TENANT_ID }}" > ~/.nebius/NEBIUS_TENANT_ID.txt
          sky check lambda runpod vast primeintellect nebius
      - name: Stream Logs (hours 30-36)
        id: monitor
        run: |
          CLUSTER="${{ needs.launch-training.outputs.cluster_name }}"
          echo "=== Monitor job 6/12: Streaming logs for $CLUSTER ==="
          sky logs "$CLUSTER" 2>&1 | tee /tmp/logs.txt || true
          if grep -q "Job finished (status: SUCCEEDED)" /tmp/logs.txt; then
            echo "status=SUCCEEDED" >> $GITHUB_OUTPUT
          elif grep -q "Job finished (status: FAILED)" /tmp/logs.txt; then
            echo "status=FAILED" >> $GITHUB_OUTPUT
          else
            echo "status=RUNNING" >> $GITHUB_OUTPUT
          fi
      - name: Cleanup if done
        if: steps.monitor.outputs.status == 'SUCCEEDED' || steps.monitor.outputs.status == 'FAILED'
        run: sky down "${{ needs.launch-training.outputs.cluster_name }}" -y || true

  monitor-7:
    needs: [launch-training, monitor-6]
    if: needs.monitor-6.outputs.status == 'RUNNING'
    runs-on: ubuntu-latest
    timeout-minutes: 350
    outputs:
      status: ${{ steps.monitor.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - name: Setup SkyPilot
        run: |
          pip install "skypilot[lambda,runpod,vast,primeintellect,nebius]" runpod prime
          mkdir -p ~/.lambda_cloud && echo "api_key = ${{ secrets.LAMBDA_API_KEY }}" > ~/.lambda_cloud/lambda_keys
          runpod config "${{ secrets.RUNPOD_API_KEY }}"
          mkdir -p ~/.config/vastai && echo "${{ secrets.VAST_API_KEY }}" > ~/.config/vastai/vast_api_key
          prime config set-api-key "${{ secrets.PRIME_INTELLECT_API_KEY }}"
          mkdir -p ~/.nebius && echo '${{ secrets.NEBIUS_CREDENTIALS_JSON }}' > ~/.nebius/credentials.json
          echo "${{ secrets.NEBIUS_TENANT_ID }}" > ~/.nebius/NEBIUS_TENANT_ID.txt
          sky check lambda runpod vast primeintellect nebius
      - name: Stream Logs (hours 36-42)
        id: monitor
        run: |
          CLUSTER="${{ needs.launch-training.outputs.cluster_name }}"
          echo "=== Monitor job 7/12: Streaming logs for $CLUSTER ==="
          sky logs "$CLUSTER" 2>&1 | tee /tmp/logs.txt || true
          if grep -q "Job finished (status: SUCCEEDED)" /tmp/logs.txt; then
            echo "status=SUCCEEDED" >> $GITHUB_OUTPUT
          elif grep -q "Job finished (status: FAILED)" /tmp/logs.txt; then
            echo "status=FAILED" >> $GITHUB_OUTPUT
          else
            echo "status=RUNNING" >> $GITHUB_OUTPUT
          fi
      - name: Cleanup if done
        if: steps.monitor.outputs.status == 'SUCCEEDED' || steps.monitor.outputs.status == 'FAILED'
        run: sky down "${{ needs.launch-training.outputs.cluster_name }}" -y || true

  monitor-8:
    needs: [launch-training, monitor-7]
    if: needs.monitor-7.outputs.status == 'RUNNING'
    runs-on: ubuntu-latest
    timeout-minutes: 350
    outputs:
      status: ${{ steps.monitor.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - name: Setup SkyPilot
        run: |
          pip install "skypilot[lambda,runpod,vast,primeintellect,nebius]" runpod prime
          mkdir -p ~/.lambda_cloud && echo "api_key = ${{ secrets.LAMBDA_API_KEY }}" > ~/.lambda_cloud/lambda_keys
          runpod config "${{ secrets.RUNPOD_API_KEY }}"
          mkdir -p ~/.config/vastai && echo "${{ secrets.VAST_API_KEY }}" > ~/.config/vastai/vast_api_key
          prime config set-api-key "${{ secrets.PRIME_INTELLECT_API_KEY }}"
          mkdir -p ~/.nebius && echo '${{ secrets.NEBIUS_CREDENTIALS_JSON }}' > ~/.nebius/credentials.json
          echo "${{ secrets.NEBIUS_TENANT_ID }}" > ~/.nebius/NEBIUS_TENANT_ID.txt
          sky check lambda runpod vast primeintellect nebius
      - name: Stream Logs (hours 42-48)
        id: monitor
        run: |
          CLUSTER="${{ needs.launch-training.outputs.cluster_name }}"
          echo "=== Monitor job 8/12: Streaming logs for $CLUSTER ==="
          sky logs "$CLUSTER" 2>&1 | tee /tmp/logs.txt || true
          if grep -q "Job finished (status: SUCCEEDED)" /tmp/logs.txt; then
            echo "status=SUCCEEDED" >> $GITHUB_OUTPUT
          elif grep -q "Job finished (status: FAILED)" /tmp/logs.txt; then
            echo "status=FAILED" >> $GITHUB_OUTPUT
          else
            echo "status=RUNNING" >> $GITHUB_OUTPUT
          fi
      - name: Cleanup if done
        if: steps.monitor.outputs.status == 'SUCCEEDED' || steps.monitor.outputs.status == 'FAILED'
        run: sky down "${{ needs.launch-training.outputs.cluster_name }}" -y || true

  monitor-9:
    needs: [launch-training, monitor-8]
    if: needs.monitor-8.outputs.status == 'RUNNING'
    runs-on: ubuntu-latest
    timeout-minutes: 350
    outputs:
      status: ${{ steps.monitor.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - name: Setup SkyPilot
        run: |
          pip install "skypilot[lambda,runpod,vast,primeintellect,nebius]" runpod prime
          mkdir -p ~/.lambda_cloud && echo "api_key = ${{ secrets.LAMBDA_API_KEY }}" > ~/.lambda_cloud/lambda_keys
          runpod config "${{ secrets.RUNPOD_API_KEY }}"
          mkdir -p ~/.config/vastai && echo "${{ secrets.VAST_API_KEY }}" > ~/.config/vastai/vast_api_key
          prime config set-api-key "${{ secrets.PRIME_INTELLECT_API_KEY }}"
          mkdir -p ~/.nebius && echo '${{ secrets.NEBIUS_CREDENTIALS_JSON }}' > ~/.nebius/credentials.json
          echo "${{ secrets.NEBIUS_TENANT_ID }}" > ~/.nebius/NEBIUS_TENANT_ID.txt
          sky check lambda runpod vast primeintellect nebius
      - name: Stream Logs (hours 48-54)
        id: monitor
        run: |
          CLUSTER="${{ needs.launch-training.outputs.cluster_name }}"
          echo "=== Monitor job 9/12: Streaming logs for $CLUSTER ==="
          sky logs "$CLUSTER" 2>&1 | tee /tmp/logs.txt || true
          if grep -q "Job finished (status: SUCCEEDED)" /tmp/logs.txt; then
            echo "status=SUCCEEDED" >> $GITHUB_OUTPUT
          elif grep -q "Job finished (status: FAILED)" /tmp/logs.txt; then
            echo "status=FAILED" >> $GITHUB_OUTPUT
          else
            echo "status=RUNNING" >> $GITHUB_OUTPUT
          fi
      - name: Cleanup if done
        if: steps.monitor.outputs.status == 'SUCCEEDED' || steps.monitor.outputs.status == 'FAILED'
        run: sky down "${{ needs.launch-training.outputs.cluster_name }}" -y || true

  monitor-10:
    needs: [launch-training, monitor-9]
    if: needs.monitor-9.outputs.status == 'RUNNING'
    runs-on: ubuntu-latest
    timeout-minutes: 350
    outputs:
      status: ${{ steps.monitor.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - name: Setup SkyPilot
        run: |
          pip install "skypilot[lambda,runpod,vast,primeintellect,nebius]" runpod prime
          mkdir -p ~/.lambda_cloud && echo "api_key = ${{ secrets.LAMBDA_API_KEY }}" > ~/.lambda_cloud/lambda_keys
          runpod config "${{ secrets.RUNPOD_API_KEY }}"
          mkdir -p ~/.config/vastai && echo "${{ secrets.VAST_API_KEY }}" > ~/.config/vastai/vast_api_key
          prime config set-api-key "${{ secrets.PRIME_INTELLECT_API_KEY }}"
          mkdir -p ~/.nebius && echo '${{ secrets.NEBIUS_CREDENTIALS_JSON }}' > ~/.nebius/credentials.json
          echo "${{ secrets.NEBIUS_TENANT_ID }}" > ~/.nebius/NEBIUS_TENANT_ID.txt
          sky check lambda runpod vast primeintellect nebius
      - name: Stream Logs (hours 54-60)
        id: monitor
        run: |
          CLUSTER="${{ needs.launch-training.outputs.cluster_name }}"
          echo "=== Monitor job 10/12: Streaming logs for $CLUSTER ==="
          sky logs "$CLUSTER" 2>&1 | tee /tmp/logs.txt || true
          if grep -q "Job finished (status: SUCCEEDED)" /tmp/logs.txt; then
            echo "status=SUCCEEDED" >> $GITHUB_OUTPUT
          elif grep -q "Job finished (status: FAILED)" /tmp/logs.txt; then
            echo "status=FAILED" >> $GITHUB_OUTPUT
          else
            echo "status=RUNNING" >> $GITHUB_OUTPUT
          fi
      - name: Cleanup if done
        if: steps.monitor.outputs.status == 'SUCCEEDED' || steps.monitor.outputs.status == 'FAILED'
        run: sky down "${{ needs.launch-training.outputs.cluster_name }}" -y || true

  monitor-11:
    needs: [launch-training, monitor-10]
    if: needs.monitor-10.outputs.status == 'RUNNING'
    runs-on: ubuntu-latest
    timeout-minutes: 350
    outputs:
      status: ${{ steps.monitor.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - name: Setup SkyPilot
        run: |
          pip install "skypilot[lambda,runpod,vast,primeintellect,nebius]" runpod prime
          mkdir -p ~/.lambda_cloud && echo "api_key = ${{ secrets.LAMBDA_API_KEY }}" > ~/.lambda_cloud/lambda_keys
          runpod config "${{ secrets.RUNPOD_API_KEY }}"
          mkdir -p ~/.config/vastai && echo "${{ secrets.VAST_API_KEY }}" > ~/.config/vastai/vast_api_key
          prime config set-api-key "${{ secrets.PRIME_INTELLECT_API_KEY }}"
          mkdir -p ~/.nebius && echo '${{ secrets.NEBIUS_CREDENTIALS_JSON }}' > ~/.nebius/credentials.json
          echo "${{ secrets.NEBIUS_TENANT_ID }}" > ~/.nebius/NEBIUS_TENANT_ID.txt
          sky check lambda runpod vast primeintellect nebius
      - name: Stream Logs (hours 60-66)
        id: monitor
        run: |
          CLUSTER="${{ needs.launch-training.outputs.cluster_name }}"
          echo "=== Monitor job 11/12: Streaming logs for $CLUSTER ==="
          sky logs "$CLUSTER" 2>&1 | tee /tmp/logs.txt || true
          if grep -q "Job finished (status: SUCCEEDED)" /tmp/logs.txt; then
            echo "status=SUCCEEDED" >> $GITHUB_OUTPUT
          elif grep -q "Job finished (status: FAILED)" /tmp/logs.txt; then
            echo "status=FAILED" >> $GITHUB_OUTPUT
          else
            echo "status=RUNNING" >> $GITHUB_OUTPUT
          fi
      - name: Cleanup if done
        if: steps.monitor.outputs.status == 'SUCCEEDED' || steps.monitor.outputs.status == 'FAILED'
        run: sky down "${{ needs.launch-training.outputs.cluster_name }}" -y || true

  monitor-12:
    needs: [launch-training, monitor-11]
    if: needs.monitor-11.outputs.status == 'RUNNING'
    runs-on: ubuntu-latest
    timeout-minutes: 350
    outputs:
      status: ${{ steps.monitor.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - name: Setup SkyPilot
        run: |
          pip install "skypilot[lambda,runpod,vast,primeintellect,nebius]" runpod prime
          mkdir -p ~/.lambda_cloud && echo "api_key = ${{ secrets.LAMBDA_API_KEY }}" > ~/.lambda_cloud/lambda_keys
          runpod config "${{ secrets.RUNPOD_API_KEY }}"
          mkdir -p ~/.config/vastai && echo "${{ secrets.VAST_API_KEY }}" > ~/.config/vastai/vast_api_key
          prime config set-api-key "${{ secrets.PRIME_INTELLECT_API_KEY }}"
          mkdir -p ~/.nebius && echo '${{ secrets.NEBIUS_CREDENTIALS_JSON }}' > ~/.nebius/credentials.json
          echo "${{ secrets.NEBIUS_TENANT_ID }}" > ~/.nebius/NEBIUS_TENANT_ID.txt
          sky check lambda runpod vast primeintellect nebius
      - name: Stream Logs (hours 66-72)
        id: monitor
        run: |
          CLUSTER="${{ needs.launch-training.outputs.cluster_name }}"
          echo "=== Monitor job 12/12 (FINAL): Streaming logs for $CLUSTER ==="
          sky logs "$CLUSTER" 2>&1 | tee /tmp/logs.txt || true
          if grep -q "Job finished (status: SUCCEEDED)" /tmp/logs.txt; then
            echo "status=SUCCEEDED" >> $GITHUB_OUTPUT
          elif grep -q "Job finished (status: FAILED)" /tmp/logs.txt; then
            echo "status=FAILED" >> $GITHUB_OUTPUT
          else
            echo "status=RUNNING" >> $GITHUB_OUTPUT
          fi
      - name: Cleanup if done
        if: steps.monitor.outputs.status == 'SUCCEEDED' || steps.monitor.outputs.status == 'FAILED'
        run: sky down "${{ needs.launch-training.outputs.cluster_name }}" -y || true

  # Final notification job - runs after any monitor completes or all skip
  notify-completion:
    needs: [launch-training, monitor-1, monitor-2, monitor-3, monitor-4, monitor-5, monitor-6, monitor-7, monitor-8, monitor-9, monitor-10, monitor-11, monitor-12]
    if: always() && needs.launch-training.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Determine final status
        id: final
        run: |
          # Check each monitor in reverse order to find the last one that ran
          for i in 12 11 10 9 8 7 6 5 4 3 2 1; do
            case $i in
              12) STATUS="${{ needs.monitor-12.outputs.status }}" ;;
              11) STATUS="${{ needs.monitor-11.outputs.status }}" ;;
              10) STATUS="${{ needs.monitor-10.outputs.status }}" ;;
              9) STATUS="${{ needs.monitor-9.outputs.status }}" ;;
              8) STATUS="${{ needs.monitor-8.outputs.status }}" ;;
              7) STATUS="${{ needs.monitor-7.outputs.status }}" ;;
              6) STATUS="${{ needs.monitor-6.outputs.status }}" ;;
              5) STATUS="${{ needs.monitor-5.outputs.status }}" ;;
              4) STATUS="${{ needs.monitor-4.outputs.status }}" ;;
              3) STATUS="${{ needs.monitor-3.outputs.status }}" ;;
              2) STATUS="${{ needs.monitor-2.outputs.status }}" ;;
              1) STATUS="${{ needs.monitor-1.outputs.status }}" ;;
            esac
            if [ -n "$STATUS" ]; then
              echo "status=$STATUS" >> $GITHUB_OUTPUT
              echo "Final status from monitor-$i: $STATUS"
              exit 0
            fi
          done
          echo "status=UNKNOWN" >> $GITHUB_OUTPUT

      - name: Notify Slack - Completed
        if: steps.final.outputs.status == 'SUCCEEDED'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "thread_ts": "${{ needs.launch-training.outputs.slack_ts }}",
              "text": "‚úÖ Training Completed",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "‚úÖ Training Completed" } },
                { "type": "section", "fields": [
                  { "type": "mrkdwn", "text": "*Cluster:*\n`${{ needs.launch-training.outputs.cluster_name }}`" },
                  { "type": "mrkdwn", "text": "*Status:*\n`SUCCEEDED`" }
                ]},
                { "type": "section", "text": { "type": "mrkdwn", "text": "<https://wandb.ai/thefleet/fleet-task-grpo|View Results on WandB>" } }
              ]
            }

      - name: Notify Slack - Failed
        if: steps.final.outputs.status == 'FAILED'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "thread_ts": "${{ needs.launch-training.outputs.slack_ts }}",
              "text": "‚ùå Training Failed",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "‚ùå Training Failed" } },
                { "type": "section", "fields": [
                  { "type": "mrkdwn", "text": "*Cluster:*\n`${{ needs.launch-training.outputs.cluster_name }}`" },
                  { "type": "mrkdwn", "text": "*Status:*\n`FAILED`" }
                ]},
                { "type": "section", "text": { "type": "mrkdwn", "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>" } }
              ]
            }

      - name: Notify Slack - Still Running (72h limit reached)
        if: steps.final.outputs.status == 'RUNNING'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "thread_ts": "${{ needs.launch-training.outputs.slack_ts }}",
              "text": "‚è≥ Training Still Running (72h workflow limit reached)",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "‚è≥ Training Still Running" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "GHA workflow hit 72h limit. Training continues on GPU.\n\n*Cluster:* `${{ needs.launch-training.outputs.cluster_name }}`\n*Monitor:* <https://wandb.ai/thefleet/fleet-task-grpo|WandB>\n*Logs:* `sky logs ${{ needs.launch-training.outputs.cluster_name }}`\n*Stop:* `sky down ${{ needs.launch-training.outputs.cluster_name }} -y`" } }
              ]
            }

      - name: Summary
        if: always()
        run: |
          echo "## Training Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster | \`${{ needs.launch-training.outputs.cluster_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | \`${{ steps.final.outputs.status }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| WandB | \`${{ needs.launch-training.outputs.wandb_run_name }}\` |" >> $GITHUB_STEP_SUMMARY
