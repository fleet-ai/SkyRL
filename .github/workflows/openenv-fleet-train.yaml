name: "Fleet Task Training (SkyPilot)"

on:
  workflow_dispatch:
    inputs:
      modality:
        description: "Task modality"
        type: choice
        options:
          - tool_use
          - computer_use
        default: tool_use
      env_key:
        description: "Fleet environment filter (empty=all, or: github, booking, reddit, etc.)"
        type: string
        default: ""
      max_tasks:
        description: "Max tasks (empty=all, or number for testing)"
        type: string
        default: ""
      cloud:
        description: "Preferred cloud (any = auto-select cheapest)"
        type: choice
        options:
          - any
          - lambda
          - runpod
          - vast
        default: any

permissions:
  contents: read

env:
  RUN_NAME_PREFIX: "fleet-task"

jobs:
  launch-training:
    runs-on: ubuntu-latest
    env:
      # Make both keys available as env vars for bash selection
      WANDB_KEY_TOOL_USE: ${{ secrets.WANDB_API_KEY_TOOL_USE }}
      WANDB_KEY_COMPUTER_USE: ${{ secrets.WANDB_API_KEY_COMPUTER_USE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install SkyPilot
        run: pip install "skypilot[lambda,runpod,vast]"

      - name: Configure Cloud Credentials
        run: |
          # Lambda
          mkdir -p ~/.lambda_cloud
          echo "api_key = ${{ secrets.LAMBDA_API_KEY }}" > ~/.lambda_cloud/lambda_keys

          # RunPod
          pip install runpod
          runpod config "${{ secrets.RUNPOD_API_KEY }}"

          # Vast.ai
          mkdir -p ~/.config/vastai
          echo "${{ secrets.VAST_API_KEY }}" > ~/.config/vastai/vast_api_key

      - name: Verify Cloud Credentials
        run: sky check lambda runpod vast

      - name: Configure SkyPilot
        run: |
          mkdir -p ~/.sky
          echo "jobs:" > ~/.sky/config.yaml
          echo "  controller:" >> ~/.sky/config.yaml
          echo "    resources:" >> ~/.sky/config.yaml
          echo "      disk_size: 30" >> ~/.sky/config.yaml
          cat ~/.sky/config.yaml

      - name: Generate Job Name
        id: job_name
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          JOB_NAME="${{ env.RUN_NAME_PREFIX }}-${{ inputs.modality }}-${SHORT_SHA}-${TIMESTAMP}"
          echo "name=$JOB_NAME" >> $GITHUB_OUTPUT
          echo "Generated job name: $JOB_NAME"

      - name: Submit Training Job
        id: submit
        run: |
          MODALITY="${{ inputs.modality }}"
          ENV_KEY="${{ inputs.env_key }}"
          MAX_TASKS="${{ inputs.max_tasks }}"

          # Select WandB key based on modality
          if [ "$MODALITY" == "tool_use" ]; then
            WANDB_KEY="$WANDB_KEY_TOOL_USE"
          else
            WANDB_KEY="$WANDB_KEY_COMPUTER_USE"
          fi

          # Validate key is set
          if [ -z "$WANDB_KEY" ]; then
            echo "ERROR: WANDB_API_KEY_${MODALITY^^} secret is not set!"
            exit 1
          fi

          # Build launch command
          LAUNCH_CMD="sky jobs launch skyrl-train/tasks/openenv-fleet-grpo.yaml"
          LAUNCH_CMD="$LAUNCH_CMD --name ${{ steps.job_name.outputs.name }}"
          LAUNCH_CMD="$LAUNCH_CMD --env WANDB_API_KEY=$WANDB_KEY"
          LAUNCH_CMD="$LAUNCH_CMD --env FLEET_API_KEY=${{ secrets.FLEET_API_KEY }}"
          LAUNCH_CMD="$LAUNCH_CMD --env MODALITY=$MODALITY"
          LAUNCH_CMD="$LAUNCH_CMD --env PR_NUMBER=${{ github.event.pull_request.number || '0' }}"

          if [ -n "$ENV_KEY" ]; then
            LAUNCH_CMD="$LAUNCH_CMD --env ENV_KEY=$ENV_KEY"
          fi

          if [ -n "$MAX_TASKS" ]; then
            LAUNCH_CMD="$LAUNCH_CMD --env MAX_TASKS=$MAX_TASKS"
          fi

          LAUNCH_CMD="$LAUNCH_CMD -y"

          # Submit job (returns after job is queued, doesn't wait for completion)
          echo "Submitting job..."
          eval "$LAUNCH_CMD" 2>&1 | tee /tmp/launch_output.txt
          LAUNCH_EXIT_CODE=${PIPESTATUS[0]}

          # Extract job ID from output (try multiple patterns)
          JOB_ID=$(grep -E "Job ID: [0-9]+" /tmp/launch_output.txt | grep -oE "[0-9]+" | head -1 || true)
          if [ -z "$JOB_ID" ]; then
            JOB_ID=$(grep -E "Job submitted.*ID: [0-9]+" /tmp/launch_output.txt | grep -oE "[0-9]+" | head -1 || true)
          fi
          if [ -z "$JOB_ID" ]; then
            JOB_ID=$(grep -E "Managed job launched" /tmp/launch_output.txt | grep -oE "[0-9]+" | head -1 || true)
          fi
          JOB_ID=${JOB_ID:-"unknown"}
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "Job ID: $JOB_ID"

          # Check if submission succeeded
          if [ $LAUNCH_EXIT_CODE -ne 0 ]; then
            echo "Job submission failed with exit code $LAUNCH_EXIT_CODE"
            exit $LAUNCH_EXIT_CODE
          fi

          echo "Job submitted successfully!"

      - name: Notify Slack - Job Submitted
        if: success()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "text": "üöÄ Fleet Training Job Submitted",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "üöÄ Fleet Training Job Submitted" }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Job Name:*\n`${{ steps.job_name.outputs.name }}`" },
                    { "type": "mrkdwn", "text": "*Job ID:*\n`${{ steps.submit.outputs.job_id }}`" },
                    { "type": "mrkdwn", "text": "*Modality:*\n`${{ inputs.modality }}`" },
                    { "type": "mrkdwn", "text": "*Env Filter:*\n`${{ inputs.env_key || 'all' }}`" }
                  ]
                },
                {
                  "type": "section",
                  "text": { "type": "mrkdwn", "text": "*Status:* Provisioning GPU instance and starting training...\n*WandB:* <https://wandb.ai/fleet-ai/fleet-task-grpo|View Dashboard>" }
                },
                {
                  "type": "context",
                  "elements": [
                    { "type": "mrkdwn", "text": "Triggered by: ${{ github.actor }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>" }
                  ]
                }
              ]
            }

      - name: Stream Training Logs
        id: stream
        run: |
          JOB_ID="${{ steps.submit.outputs.job_id }}"

          if [ "$JOB_ID" == "unknown" ]; then
            echo "ERROR: Could not determine job ID"
            exit 1
          fi

          echo "Streaming logs for job $JOB_ID..."
          echo "This step will run until the job completes or fails."
          echo ""

          # Stream logs until job completes (this blocks)
          sky jobs logs --follow "$JOB_ID" || true

          # Get final job status
          echo ""
          echo "=== Final Job Status ==="
          sky jobs queue | grep -E "^$JOB_ID|ID" || true

          # Check if job succeeded
          JOB_STATUS=$(sky jobs queue 2>/dev/null | grep "^$JOB_ID" | awk '{print $2}' || echo "UNKNOWN")
          echo "job_status=$JOB_STATUS" >> $GITHUB_OUTPUT
          echo "Final status: $JOB_STATUS"

          if [ "$JOB_STATUS" == "SUCCEEDED" ]; then
            echo "Job completed successfully!"
            exit 0
          elif [ "$JOB_STATUS" == "RUNNING" ]; then
            echo "Job is still running (log streaming ended)"
            exit 0
          else
            echo "Job ended with status: $JOB_STATUS"
            exit 1
          fi

      - name: Notify Slack - Job Completed
        if: success()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "text": "‚úÖ Fleet Training Job Completed",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "‚úÖ Fleet Training Job Completed" }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Job Name:*\n`${{ steps.job_name.outputs.name }}`" },
                    { "type": "mrkdwn", "text": "*Job ID:*\n`${{ steps.submit.outputs.job_id }}`" },
                    { "type": "mrkdwn", "text": "*Modality:*\n`${{ inputs.modality }}`" },
                    { "type": "mrkdwn", "text": "*Status:*\n`${{ steps.stream.outputs.job_status }}`" }
                  ]
                },
                {
                  "type": "section",
                  "text": { "type": "mrkdwn", "text": "*WandB:*\n<https://wandb.ai/fleet-ai/fleet-task-grpo|View Training Results>" }
                },
                {
                  "type": "context",
                  "elements": [
                    { "type": "mrkdwn", "text": "Triggered by: ${{ github.actor }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>" }
                  ]
                }
              ]
            }

      - name: Notify Slack - Job Failed
        if: failure()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "text": "‚ùå Fleet Training Job Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "‚ùå Fleet Training Job Failed" }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Job Name:*\n`${{ steps.job_name.outputs.name }}`" },
                    { "type": "mrkdwn", "text": "*Job ID:*\n`${{ steps.submit.outputs.job_id }}`" },
                    { "type": "mrkdwn", "text": "*Modality:*\n`${{ inputs.modality }}`" },
                    { "type": "mrkdwn", "text": "*Status:*\n`${{ steps.stream.outputs.job_status || 'FAILED' }}`" }
                  ]
                },
                {
                  "type": "section",
                  "text": { "type": "mrkdwn", "text": "*Check logs:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Logs>" }
                },
                {
                  "type": "context",
                  "elements": [
                    { "type": "mrkdwn", "text": "Triggered by: ${{ github.actor }}" }
                  ]
                }
              ]
            }

      - name: Summary
        if: always()
        run: |
          echo "## Fleet Training Job - ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Job Name | \`${{ steps.job_name.outputs.name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Job ID | \`${{ steps.submit.outputs.job_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Final Status | \`${{ steps.stream.outputs.job_status || 'N/A' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Modality | \`${{ inputs.modality }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Env Filter | \`${{ inputs.env_key || 'all' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Max Tasks | \`${{ inputs.max_tasks || 'all' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [WandB Dashboard](https://wandb.ai/fleet-ai/fleet-task-grpo)" >> $GITHUB_STEP_SUMMARY
